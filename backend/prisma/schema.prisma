// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  zid                 Int                @id @default(autoincrement())
  firstName           String
  lastName            String
  email               String             @unique
  password            String
  isAdmin             Boolean            @default(false)
  
  coursesLectured     CourseOffering[]   @relation("Lecturer")
  coursesTutored      CourseOffering[]   @relation("Tutors")
  coursesEnrolled     CourseOffering[]   @relation("EnrolledStudents")

  submissions         Submission[]
  groups              Group[]
  ELSDuration         ELSDuration?

  classesTutored      Class[]            @relation("Tutor")
  classesIn           Class[]            @relation("InClass")
  
  // This refers to the submissions that the user has marked
}

model Course {
  id                 Int                @id @default(autoincrement())
  name               String
  code               String             @unique
  description        String

  courseOfferings     CourseOffering[]
}

model Term {
  year                   Int
  term                   Trimester

  @@id([year, term])

  courseOfferings        CourseOffering[]
}

enum Trimester {
  T0
  T1
  T2
  T3
}

model CourseOffering {
  id                 Int                @id @default(autoincrement())

  courseId           Int
  course             Course             @relation(fields: [courseId], references: [id])

  termYear           Int
  termTerm           Trimester
  term               Term               @relation(fields: [termYear, termTerm], references: [year, term])

  @@unique([courseId, termYear, termTerm])

  lecturerId         Int
  lecturer           User               @relation("Lecturer", fields: [lecturerId], references: [zid])
  tutors             User[]             @relation("Tutors")
  enrolledStudents   User[]             @relation("EnrolledStudents")
  assignments        Assignment[]
  classes            Class[]

  penaltyStrategy    PenaltyStrategy    @default(Hourly)
}

model Class {
  id                 Int                @id @default(autoincrement())
  name               String
  startTime          String
  duration           Int
  day                Day

  tutorId            Int
  tutor              User               @relation("Tutor",fields: [tutorId], references: [zid])

  courseOfferingId   Int
  courseOffering     CourseOffering     @relation(fields: [courseOfferingId], references: [id])

  students           User[]             @relation("InClass")
}

enum Day {
  Monday
  Tuesday
  Wednesday
  Thursday
  Friday
  Saturday
  Sunday
}

enum PenaltyStrategy {
  Hourly
  Daily
}

model Assignment {
  id                 Int                @id @default(autoincrement())
  name               String
  description        String
  dueDate            DateTime
  isGroupAssignment  Boolean
  defaultShCmd       String
  autoTestWeighting  Decimal            
  autoTestExecutable String?

  courseOfferingId   Int
  courseOffering     CourseOffering     @relation(fields: [courseOfferingId], references: [id])

  submissions        Submission[]
  testCases          TestCase[]
}

model Submission {
  id                 Int                 @id @default(autoincrement())
  filePath           String
  submissionTime     DateTime            @default(now())
  submissionType     SubmissionType

  assignmentId       Int
  assignment         Assignment          @relation(fields: [assignmentId], references: [id])

  studentId          Int?
  student            User?               @relation(fields: [studentId], references: [zid])

  groupId            Int?
  group              Group?              @relation(fields: [groupId], references: [id])

  isMarked           Boolean             @default(false)
  autoMarkResult     Decimal?
  styleMarkResult    Decimal?
  finalMark          Decimal?
  markerComments     String?
  latePenalty        Decimal?
}

enum SubmissionType {
  Individual
  Group
}

model TestCase {
  id                 Int                @id @default(autoincrement())
  input              String
  expectedOutput     String
  isHidden           Boolean            @default(false)

  assignmentId       Int
  assignment         Assignment         @relation(fields: [assignmentId], references: [id])
}

model Group {
  id                 Int                @id @default(autoincrement())
  name               String

  members            User[]
  submissions        Submission[]
}

model ELSType {
  id                Int                @id @default(autoincrement())
  // How many extra days are allowed for the assignment
  extraDays         Int                @default(0)

  ELSDurations      ELSDuration[]
}

model ELSDuration {
  startDate         DateTime
  endDate           DateTime

  studentId         Int                @unique
  student           User               @relation(fields: [studentId], references: [zid])

  elsTypeId         Int
  elsType           ELSType            @relation(fields: [elsTypeId], references: [id])

  @@id([studentId, elsTypeId])
}