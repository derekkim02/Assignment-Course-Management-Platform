// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  zid                 Int                @id @default(autoincrement())
  firstName           String
  lastName            String
  email               String             @unique
  password            String

  teachingAssignments TeachingAssignment[]
  markingAssignments  MarkingAssignment[]
  groups              Group[]
  ELSDuration         ELSDuration?
  admin               Admin[]
  // This refers to the submissions that the user has marked
  marks               Mark[]
}

model Course {
  id                 Int                @id @default(autoincrement())
  name               String
  code               String             @unique
  description        String

  teachingAssignments TeachingAssignment[]
  markingAssignments  MarkingAssignment[]
  assignments         Assignment[]
}

model Term {
  year                   Int
  term                   Trimester

  @@id([year, term])

  teachingAssignments    TeachingAssignment[]
  markingAssignments     MarkingAssignment[]
  assignments            Assignment[]
  ELSStart ELSDuration[] @relation("StartTerm")
  ELSEnd ELSDuration[]   @relation("EndTerm")
}

enum Trimester {
  T1
  T2
  T3
}

model TeachingAssignment {
  lecturerId         Int
  lecturer           User               @relation(fields: [lecturerId], references: [zid])

  courseId           Int
  course             Course             @relation(fields: [courseId], references: [id])

  termYear           Int
  termTerm           Trimester
  term               Term               @relation(fields: [termYear, termTerm], references: [year, term])

  @@id([lecturerId, courseId, termYear, termTerm])
}

model MarkingAssignment {
  markerId           Int
  marker             User               @relation(fields: [markerId], references: [zid])

  termYear           Int
  termTerm           Trimester
  term               Term               @relation(fields: [termYear, termTerm], references: [year, term])

  courseCode         String
  course             Course             @relation(fields: [courseCode], references: [code])

  @@id([markerId, courseCode, termYear, termTerm])
}

model Assignment {
  id                 Int                @id @default(autoincrement())
  name               String
  description        String
  dueDate            DateTime

  termYear           Int
  termTerm           Trimester
  term               Term               @relation(fields: [termYear, termTerm], references: [year, term])

  courseId           Int
  course             Course             @relation(fields: [courseId], references: [id])

  testCases          TestCase[]
  groups             Group[]
}

model TestCase {
  id                 Int                @id @default(autoincrement())
  filePath           String

  assignmentId       Int                @unique
  assignment         Assignment         @relation(fields: [assignmentId], references: [id])
}

model Submission {
  id                 Int                @id @default(autoincrement())
  filePath           String
  submissionTime     DateTime
  latePenalty        Int

  groupId            Int
  group              Group              @relation(fields: [groupId], references: [id])

  mark               Mark?
}

model Group {
  id                 Int                @id @default(autoincrement())
  name               String
  size               Int

  assignmentId       Int
  assignment         Assignment         @relation(fields: [assignmentId], references: [id])

  members            User[]
  submissions        Submission[]
}

model Mark {
  mark               Decimal
  feedback           String
  isMarked           Boolean

  submissionId       Int                @unique
  submission         Submission         @relation(fields: [submissionId], references: [id])

  markerId           Int
  marker             User               @relation(fields: [markerId], references: [zid])

  @@id([submissionId, markerId])
}

model ELSType {
  id                Int                @id @default(autoincrement())
  // How many extra days are allowed for the assignment
  extraDays         Int                @default(0)

  ELSDurations      ELSDuration[]
}

model ELSDuration {
  studentId         Int                @unique
  student           User               @relation(fields: [studentId], references: [zid])

  elsTypeId         Int
  elsType           ELSType            @relation(fields: [elsTypeId], references: [id])

  startYear         Int
  startTerm         Trimester
  start             Term               @relation("StartTerm", fields: [startYear, startTerm], references: [year, term])

  endYear           Int
  endTerm           Trimester
  end               Term               @relation("EndTerm", fields: [endYear, endTerm], references: [year, term])

  @@id([studentId, elsTypeId])
}

model Admin {
  zid                 Int                @id
  user                User               @relation(fields: [zid], references: [zid])
}